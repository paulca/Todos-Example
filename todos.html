<!DOCTYPE html>

<html>
  <head>
    <link rel="stylesheet" href="todos.css" type="text/css" media="screen" charset="utf-8">
    <title>Todos</title>
    
    <div id="todos"><h1>Todos</h1>
      <div>
        <form id="new-todo">
          <input placeholder="What to do?" type="text" name="text">
        </form>
      </div>

      <div id="stats">
        <div>
          <button id="clear-completed">Clear Completed Todos</button>
        </div>
        <span id="number-of-items">0 items</span>
      </div>

      <div>
        <label class="done-label">
          <input class="mark-all-done" type="checkbox" data-bind="+todos#mark_all_done"> Mark All as Done
        </label>
      </div>

      <ul id="todo-list" data-collection="Todo">
      </ul>
    </div>
    
  </head>
  <body>
    <script src="jquery-1.6.1.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="eyeballs.js" type="text/javascript" charset="utf-8"></script>
    <script src="eyeballs.jquery.js" type="text/javascript" charset="utf-8"></script>
    
    <script type="text/javascript"> 
      o_O('Todo', function(){
        this.to_html(function(model){
          var out;
          out = '<li data-id="' + model.id +  '" data-model="Todo"><label'
          if(model.done)
          {
            out = out + ' class="is-done"'
          }
          out = out + '>'
          out = out + '<input data-id="' + model.id +  '" type="checkbox" name="done"'
          if(model.done)
          {
            out = out + 'checked="checked"'
          }
          out = out + '>'
          out = out + model.text
          out = out + '</label></li>'
          return out
        })
      });
      
      var MyApp = function(){}
      MyApp.reset_stats = function(){
        var count = o_O('Todo').all().length
        $('#number-of-items').html(count + ' items')
      }
      
      eyeballs.hooks.add({
        after_create: MyApp.reset_stats,
        after_update: MyApp.reset_stats,
        after_destroy: MyApp.reset_stats
      })
      
      $(function(){
        $('#new-todo').submit(function(){
          o_O('Todo').create({text: $(this).serializeArray()[0]['value']})
          this.reset()
          return false;
        })

        $('input[name=done]').live('click', function(){
          var todo
          todo = o_O('Todo').find($(this).data('id'))
          todo.set('done', !todo.get('done'))
        })
        
        $('input.mark-all-done').click(function(){
          var checkbox = $(this)
          o_O('Todo').all(function(todo){
            todo.set('done', checkbox.attr('checked'))
          })
        })
        
        $('#clear-completed').click(function(){
          o_O('Todo').all(function(todo){
            if(todo.get('done'))
            {
              todo.destroy();
            }
          })
        })
      })
    </script> 
  </body>
</html>
